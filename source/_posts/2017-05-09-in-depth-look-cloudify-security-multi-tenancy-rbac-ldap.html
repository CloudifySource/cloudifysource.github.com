---
layout: blogpost
title: An In-Depth Look at Cloudify 4.0 Security - Multi-Tenancy, RBAC, LDAP and more
description: In this post, Sivan gives us the down low on all things security in Cloudify Manager, including roles, access, tenants, and LDAP.
image: sivan.jpg
author: Sivan Barzily
tags: 
 - Cloud Orchestration
 - Cloud Management
 - Security
 - RBAC
 - LDAP
---

<notextile>

<img src="/img/blog/cloudify-security-header.png" alt="Cloudify Manager Security" width="870px">
<br/>
<br/>

<h2><strong>Introduction</strong></h2>
<p>Just two short weeks ago, we unveiled <a href="http://cloudify.co/2017/04/27/cloudify-4-landed-next-gen-orchestration-first-cmp.html">Cloudify 4.0</a>. This release is a huge deal in the evolution of Cloudify, and our CTO, Nati Shalom, detailed how this product is working toward a <a href="http://cloudify.co/2017/04/26/the-end-cloud-management-as-we-know-it.html">new era in Cloud Management</a>, with <a href="http://cloudify.co/2017/04/24/the-tenets-of-cloudify.html">orchestration-first, model-driven principles</a>. Security is a key component in any software, and in this post, I wanted to give you an even more detailed view at the specifics of how security works for Cloudify Manager.</p>
<p>Security, in the context of Cloudify Manager, means securing the communication with the manager and controlling who is allowed to use it to execute various operations. Secured communication is achieved by using SSL, which allows clients to validate the authenticity of the manager as well as ensure the data sent to and from it is encrypted.</p>
<p>Controlling access to the manager and permissions to take actions is implemented via Flask-Security, to support user authentication and authorization. We will get into more details on Cloudify&rsquo;s SSL and Access Control implementation and configuration a bit later.</p>

  <hr>
<span class="pullquote-left">
  <font style="font-weight: bold" size="5" face="Baskerville Old Face"><em>Watch our Cloudify 4.0 webinar on demand - the next-gen CMP.</em></font>&nbsp; <a class="btn btn-medium btn-theme btn-rounded" id="downloadBtnInner" href="{{ site.baseurl }}/webinars/the-new-cloudify-4.html?utm_campaign=4.0%20Release%20Webinar&utm_source=blog_cta&utm_medium=jeremy" target="_blank"><i class="icon-plus"></i> Go </a></span>
<hr>



<h2><strong>Early Stages of Cloudify Manager Security</strong></h2>
<p>Cloudify&rsquo;s security for client access focuses on the REST service, as this is the first and only client access point to Cloudify Manager. All requests to the manager are authenticated and authorized before reaching their endpoint. For example, when a Web-UI user attempts to upload a new blueprint, a request is sent to the REST service&rsquo;s <em>&ldquo;/blueprints&rdquo;</em> endpoint via port 80/443. The request will only reach the endpoint if the user is authenticated and authorized to upload blueprints. </p>
<p>Similarly, a user that executes the CLI command &lsquo;cfy deployments list&rsquo; triggers a request to execute GET on <em>&ldquo;/deployments&rdquo;</em>, which will only be successful if it includes valid credentials, identifying an authorized user.</p>
<p>Requests generated by other HTTP clients, such as curl, must also include valid credentials - username and password (or token, as described below) - and in future versions (4.0 onwards), a tenant name as well. If credentials are missing, invalid, or represent an unauthorized user, the request fails with a &ldquo;401: Unauthorized User&rdquo; error.</p>
<h2><strong>New in Cloudify 4.0 Security</strong></h2>
<p>Moving forward to Cloudify 4.0, we wanted make sure security was one of our top priorities. Below is a list of the main security features in this version, which we will go through in more detail:</p>
<ul>
<li>Cloudify Manager is secure by default and cannot be bootstrapped in an insecure manner</li>
<li>Communication between agents and the manager is encrypted</li>
<li>LDAP integration is improved</li>
<li>User, group, and tenant management is available (locally / LDAP)</li>
<li>Multi-tenancy for isolation between tenant resources</li>
<li>RBAC - private resources, plus built in roles for user and admin</li>
<li>Cloudify services can be configured to run under the Cloudify user and not root</li>
</ul>
<h2><strong>Authentication</strong></h2>
<p>In Cloudify 4.0, authentication is mandatory for any level of access to Cloudify Manager. Authentication is handled in one of the following ways:</p>
<ol>
<li>Username and Password - Can either be local or from a user management system the manager is configured with (LDAP-based integration is native)</li>
<li>Using a token - This can be generated by Cloudify and is valid for 10 hours</li>
</ol>
<h2><strong>Authorization</strong></h2>
<p>A combination of roles and permissions, and multi-tenancy, provide the framework for authorization and resource isolation. Let&rsquo;s look at these in detail:</p>
<p><strong>Roles &amp; Permissions</strong></p>
<p>Cloudify includes built-in user roles which users are associated with: Administrator and User. Each role has different permissions, which ensures operation-based RBAC. For example, the role User cannot perform Administrator operations, such as with snapshot management, where the User role cannot perform any actions.</p>
<p><strong>Isolation</strong></p>
<p>Cloudify supports the concept of users, user groups, and tenants. These can be defined locally in Cloudify or taken from an external user management system (LDAP integration is native). In the latter case, passwords are not stored in Cloudify - authentication is done via LDAP (or other system) and a token is generated and used for the user session.</p>
<p>A user can be associated with one or more groups, and one or more tenants. A group can also be associated with one or more tenants. An authenticated user only has access to resources that belong to that user&rsquo;s tenants.</p>
<p>Resource isolation is implemented for blueprints, artifacts, deployments, nodes, logs, events, and plugins. An additional layer of permission control is implemented on resources, allowing private resource configuration. A resource created as private will only be visible to the user who created the resource, and not to other users within the tenant. The exception is the administrator role - which has full access to all system resources. All REST APIs, except admin APIs and the version API, require a tenant, and the operation is associated with the provided tenant.</p>
<p>In the case of read operations, only information of the tenant will be provided, in case of write operations the resource is added to the tenant provided. Admin APIs are for the following resources (and unavailable for users):</p>
<ol>
<ol>
<li>Tenant management (CRUD)</li>
<li>User management (CRUD)</li>
<li>User group management (CRUD)</li>
<li>Snapshot management (CRUD)</li>
<li>Cluster management (configuration of manager HA)</li>
<li>Maintenance mode activation/deactivation</li>
<li>Upgrade/rollback commands</li>
</ol>
</ol>
<p>RabbitMQ isolation is achieved through the usage of virtual hosts and the association between hosts and users, enabling authorization at the queue/exchange level and resulting in isolation of queues between tenants. In this configuration it is impossible for a host VM from &ldquo;tenant A&rdquo; to access/request operations on host VMs that belong to &ldquo;tenant B&rdquo;. **This addition is expected in 4.1.</p>
<h2><strong>Encryption</strong></h2>
<p><strong>Scope</strong></p>
<ol>
<li>Communication from the outside world to the manager and its SSL/TLS configuration will be the user&rsquo;s responsibility (CA/host verification etc..), where the endpoints include the UI and REST API.</li>
<li>Communication between agents and the manager, as well as within the manager, is Cloudify&rsquo;s responsibility and hence will be determined by Cloudify. Cloudify will generate the necessary certificates for the internal communication.</li>
<li>Credentials will not appear in log files (cloud / RabbitMQ / Cloudify)</li>
</ol>
<p><strong>Communication Channels</strong></p>
<p>In order to make the architecture simpler, the number of internal communication channels was reduced in the following ways:</p>
<ul>
<li>Agents will poll for task execution requests by connecting to the RabbitMQ server on the manager. </li>
<li>Access to file server or REST API will be done through a secured port (authn, authz, encryption) which will be controlled by Cloudify.</li>
<li>Accessing REST API internally will not be handled by Cloudify - if a user enables SSL/auth over port 80 and decides to use a REST client, either from a plugin or a script, the user should configure it correctly.</li>
</ul>
<p><strong>Certificate Propagation</strong></p>
<p>Cloudify creates the private/public keys for the transport which will be used by both RabbitMQ and file server access. The certificate is used to identify the manager, there are no agent-host certificates. The manager certificate is propagated automatically to the agent host as part of the agent installation.</p>
<p>Certificate propagation depends on agent installation:</p>
<ul>
<li>SSH/WinRM - On agent installation, Cloudify will upload the certificate to the VM running the agent. The only limitation here is that WinRM is not encrypted in Cloudify and may pose a security risk in 4.0, but this will be resolved in 4.1</li>
<li>Cloud-init/Userdata - Inject the certificate as part of the agent installation script injected into the VM.</li>
<li>Provided - User will put the certificate in a static location on the VM.</li>
</ul>
<p class="aligncenter"><img src="/img/blog/manager-agent.png"></p>
<h2><strong>Nonrepudiation</strong></h2>
<p>SSL is enabled for agent-manager communication, as described above. In addition, using SSL for client-server communication is possible and ensures:</p>
<ol>
<li> Privacy - All communications between the client and server are encrypted </li>
<li> Trust - When a connection is established, Cloudify Manager presents a signed certificate to the client. The client can use that certificate to validate the authenticity of the manager. </li>
</ol>
<p>Requests to the manager can be addressed to its public or private IP address. By default, internal requests (i.e. requests sent from the manager itself or from agent hosts) are sent to the manager&rsquo;s private IP address, while external requests (i.e. requests originating from other, external clients) should be sent to the manager&rsquo;s public address.</p>
<p>Each of the server&rsquo;s IP addresses has a different SSL key pair, created with the matching address as its CN value. Sending a request to the wrong address could therefore fail, since the manager might present the wrong SSL certificate to the client.</p>
<h2><strong>Secret Store and More</strong></h2>
<p>Starting with 4.0, all service required by Cloudify will run under the Cloudify (and not root) user in the manager VM. The only exception is the parent process of Nginx which runs as root in order to enable usage of port 80. It is not recommended to change this behavior.</p>
<p>A secret store is implemented inside the Cloudify DB (Postgres), providing an encrypted, tenant-wide variable store:</p>
<ul>
<li>Through usage of the secret store a user can ensure all secrets (such as credentials to IaaS environments, passwords, etc) are kept in a secured manner, and adhere to isolation requirements between different tenants.</li>
<li>Secrets can be added to the store by a set function, and retrieved via get.</li>
<li>Export as environment variables enables agents to use secrets (not in 4.0).</li>
<li>Plugins can get secrets to leverage those when communicating with IaaS environments.</li>
<li>Managers should be secured via client-side SSL to ensure secrets are not passed on an unencrypted communication channel.</li>
<li>Usage of Postgres ensures replication of secrets across all managers within a cluster as part of HA.</li>
</ul>
<p>You are always welcome to <a href="http://docs.getcloudify.org/4.0.0/manager_architecture/security/">check out the docs</a> for any other information and feel free to contact us via the <a href="https://groups.google.com/forum/#!forum/cloudify-users">user group</a> or on <a href="http://cloudify.co/slack">Slack</a> for any questions.</p>

</notextile>
